# OnTheDeal 프로젝트 Claude 설정

## 프로젝트 개요
B2B 식자재 거래 플랫폼 - Next.js 14 + Prisma + PostgreSQL

---

## ⚠️ 기능 요청 처리 규칙 (매우 중요)

### 사용자가 기능 수정/추가 요청 시 필수 절차

1. **요청 내용 명확화**
   - 사용자의 요청을 정확히 이해했는지 확인
   - 불명확하면 질문하여 명확히 함

2. **README.md에 먼저 기록**
   - `README.md`의 "기능 요청 추적" 섹션에 요청 내용 추가
   - `- [ ] 요청 내용` 형식으로 "대기 중"에 추가

3. **TodoWrite로 작업 분해**
   - 요청을 세부 작업으로 분해
   - 각 작업을 TodoWrite로 등록
   - 작업 완료 시 즉시 상태 업데이트

4. **구현 후 필수 확인**
   - 해당 페이지에서 직접 확인 가능한 수정인지 체크
   - 빌드 테스트 (`npm run build`) 통과 확인
   - 관련 API가 실제로 호출되는지 확인

5. **완료 후 README.md 업데이트**
   - "대기 중"에서 "구현 완료"로 이동
   - `- [x] 완료된 내용`으로 체크 표시

### 절대 하면 안 되는 것

❌ 요청을 받고 구현 없이 "완료"라고 말하기
❌ alert만 띄우고 실제 API 미호출
❌ README.md에 기록하지 않고 진행
❌ 빌드 테스트 없이 푸시
❌ Todo 상태 업데이트 없이 다음 작업으로 넘어가기

---

## 🔍 수정 검증 체크리스트 (매우 중요)

### 수정 전 반드시 확인할 것

1. **문제의 전체 흐름 파악**
   - 프론트엔드 → API → 데이터베이스 전체 흐름 추적
   - 단순히 한 파일만 수정하면 안 됨
   - 예: API 호출 시 필요한 파라미터가 실제로 전달되는지 확인

2. **관련 파일 모두 확인**
   - 페이지 파일 (어디서 API를 호출하는지)
   - API 라우트 파일 (파라미터를 어떻게 처리하는지)
   - 스키마 파일 (필드가 존재하는지)

### 수정 후 반드시 검증할 것

1. **코드 흐름 검증**
   ```
   grep -n "관련키워드" 파일경로
   ```
   - 수정한 코드가 실제로 실행되는 경로에 있는지 확인
   - API 파라미터가 올바르게 전달되는지 확인

2. **빌드 테스트**
   ```bash
   npm run build
   ```
   - 반드시 빌드 성공 확인 후 커밋

3. **실제 동작 확인 가능한 경우**
   - 브라우저 개발자 도구 Network 탭에서 API 호출 확인
   - 콘솔 로그로 데이터 흐름 확인

### 과거 실수 사례 (반복 금지)

1. **API 파라미터 누락**
   - 문제: `/api/rfqs?role=supplier` 파라미터 없이 호출
   - 결과: 타겟팅 필터가 적용되지 않음
   - 해결: API 호출하는 페이지에서 필수 파라미터 전달 확인

2. **z-index만 수정**
   - 문제: z-index만 올려도 부모 컨테이너 영향으로 안 보임
   - 결과: 모달이 여전히 안 보임
   - 해결: createPortal로 document.body에 직접 렌더링

3. **스키마만 수정하고 API 미수정**
   - 문제: Prisma 스키마에 필드 추가했지만 API에서 사용 안 함
   - 결과: 데이터가 저장되지 않음
   - 해결: 스키마 → API → 프론트엔드 전체 흐름 수정

### TodoWrite 작성 규칙

❌ 잘못된 예: "이미지 뷰어 문제 수정"
✅ 올바른 예: "이미지 뷰어: createPortal로 document.body에 렌더링 (부모 컨테이너 영향 해결)"

❌ 잘못된 예: "재발주 기능 수정"
✅ 올바른 예: "재발주 기능: supplier/rfqs API에 role=supplier 파라미터 추가"

---

## 빌드 및 배포 규칙

### Git Push 전 필수 확인사항
1. **빌드 테스트**: `npm run build`가 성공하는지 확인
2. **README.md 업데이트**: 기능 변경 시 README 반영 확인
3. **npm ci 테스트 필수**: 의존성 변경 시 `npm ci` 테스트

### 의존성 관리
- preact@10.11.3은 next-auth 의존성으로 명시적 추가됨 (삭제 금지)
- 새 패키지 설치 후 반드시 npm ci 테스트 수행

---

## 테스트 계정 정보

| 역할 | 이메일 | 비밀번호 |
|------|--------|----------|
| 구매자 | buyer@test.com | Test1234! |
| 판매자 | supplier@test.com | Test1234! |
| 관리자 | odadmin@onthedeal.com | admin03532 |
| 관리자 | nqadmin@onthedeal.com | admin03532 |

---

## 코드 규칙

### API 라우트
- 인증 필요한 API는 `getServerSession(authOptions)` 사용
- 동적 렌더링 필요 시 `export const dynamic = 'force-dynamic'` 추가

### 용어 규칙 (매우 중요)

| 내부 코드/DB | UI 표시 (한국어) | 비고 |
|-------------|-----------------|------|
| `supplier` | **판매자** | "공급자" 사용 금지 |
| `buyer` | 구매자 | |
| `RFQ` / `rfq` | 발주 | "RFQ" 직접 표시 금지 |
| `quote` | 제안 | |
| `order` | 주문 | |
| `chatRoom` | 채팅방 / 협상 | |

**주의사항:**
- 코드 내부(변수명, DB 필드)는 영어 그대로 유지 (`supplier`, `rfq` 등)
- 사용자에게 보이는 UI 텍스트는 반드시 한국어 용어 사용
- **"공급자"는 UI에서 절대 사용 금지** → 반드시 "판매자"로 표시
- 한국어 UI 우선

---

## 크레딧 시스템 (현재 상태)

### 수수료 정책
- **제안 제출 시**: 제안가(단가 × 수량)의 **3%** 선차감
- **채팅 금액 수정 시**: 금액 증가분의 3% 추가 차감
- **거래 확정 시**: 선차감 금액이 수수료로 확정
- **미확정/거절 시**: 선차감 금액 전액 환불

### 크레딧 흐름

```
1. 공급자 제안 제출
   └─ 크레딧 3% 선차감 (제안가 기준)
   └─ 채팅방 생성 (3일 만료)

2. 채팅 중 금액 수정 (선택적)
   └─ 금액 증가 시: 차액의 3% 추가 차감
   └─ 금액 감소 시: 환불 없음

3-A. 구매자가 수락
   └─ 선차감 크레딧 유지 (추가 차감 없음)
   └─ 미선정 공급자들 크레딧 환불
   └─ 주문 생성

3-B. 구매자가 거절
   └─ 공급자 크레딧 환불

3-C. 3일 후 만료 (cron)
   └─ 공급자 크레딧 환불
   └─ 채팅방 상태 expired로 변경
```

### 크레딧 충전 요청 흐름

```
1. 공급자: /supplier/credits에서 충전 금액 선택
2. 입금 정보 확인 후 "입금 완료" 클릭
3. CreditCharge 레코드 생성 (status: pending)
4. 관리자에게 알림 전송

5. 관리자: /admin/credits에서 대기 중인 요청 확인
6. 승인 → 크레딧 충전 + 공급자 알림
   반려 → 공급자에게 반려 알림
```

---

## 코드 리뷰 체크리스트 (필수)

### 폼 제출 및 버튼 핸들러
- **모든 handleSubmit/onClick 핸들러가 실제 API를 호출하는지 확인**
- alert만 띄우거나 시뮬레이션만 하는 코드 금지
- mock 데이터 사용 시 TODO 주석으로 명시

### 크레딧 시스템
- **크레딧 차감은 제안 제출 시 1회만** (이중/삼중 차감 금지)
- 제안 수락 시: 선차감된 크레딧 유지, 미선정 공급자는 환불
- 제안 거절 시: 크레딧 환불 처리
- 채팅방 만료 시: 크레딧 환불 처리

### 알림 시스템
- 모든 중요 이벤트에 알림 생성 확인:
  - 제안 제출 → 구매자/공급자 알림
  - 제안 수락/거절 → 공급자 알림 + 크레딧 변동 알림
  - 크레딧 충전 → 공급자 알림
  - 주문 상태 변경 → 양쪽 알림
  - 채팅방 만료 → 양쪽 알림
- 알림에 적절한 link 경로 포함

### API 응답
- 성공 시: 의미있는 데이터 반환
- 실패 시: 명확한 에러 메시지 + 필요한 정보 (예: 필요 크레딧, 현재 크레딧)

---

## 자주 사용하는 명령어

```bash
# 의존성 재설치 (문제 발생 시)
rm -rf node_modules package-lock.json && npm install && npm ci

# 빌드 테스트
npm run build

# DB 시딩
npx prisma db seed

# Prisma 스키마 동기화
npx prisma generate
npx prisma db push
```

---

## 주의사항

- package-lock.json 수동 편집 금지
- node_modules 커밋 금지
- .env 파일 커밋 금지

---

## 자주 발생하는 오류 패턴

1. **API 미호출 문제**
   - handleSubmit에서 alert만 띄우고 API 미호출
   - 해결: 반드시 fetch()로 실제 API 호출

2. **크레딧 중복 차감**
   - 여러 API에서 동일한 크레딧 차감 로직
   - 해결: 제안 제출 시 1회만 차감

3. **로그인 상태 무시**
   - 로그인한 사용자에게 회원가입 페이지로 안내
   - 해결: session 확인 후 대시보드로 리다이렉트

4. **권한 체크 누락**
   - buyer/supplier 역할 체크 없이 API 실행
   - 해결: API에서 session.user.role 확인

5. **알림 누락**
   - 중요 이벤트에 알림 생성 누락
   - 해결: 모든 거래 이벤트에 양쪽 사용자 알림

---

## 디버깅 로그 확인

개발 환경에서 다음 로그 출력 확인:
- `[RFQs API]` - 발주 관련
- `[Quotes API]` - 제안 관련
- `[ChatRooms API]` - 채팅방 관련
- `[Orders API]` - 주문 관련

---

## Cron 작업

- `/api/cron/expire-chats`: 만료된 채팅방 처리 + 크레딧 환불
- 환경변수: CRON_SECRET 설정 필요
- Vercel Cron 또는 외부 서비스로 주기적 호출 필요

---

## 빌드 전 체크리스트

```bash
# 1. TypeScript 에러 확인
npm run build

# 2. 개발 서버 실행 후 수동 테스트
npm run dev

# 3. 콘솔 에러 확인 (브라우저 개발자 도구)

# 4. 네트워크 탭에서 API 호출 확인
```
