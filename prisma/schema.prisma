// Prisma Schema for OnTheDeal
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 사용자 (Users/Profiles)
// ============================================

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  password              String
  role                  UserRole  @default(buyer)

  // 사업자 정보
  companyName           String    @map("company_name")
  businessNumber        String?   @map("business_number")
  representativeName    String?   @map("representative_name")
  businessType          String?   @map("business_type")
  businessCategory      String?   @map("business_category")

  // 담당자 정보
  contactName           String    @map("contact_name")
  phone                 String
  fax                   String?

  // 주소 정보
  postalCode            String?   @map("postal_code")
  storeAddress          String?   @map("store_address")
  storeDetailAddress    String?   @map("store_detail_address")
  address               String?

  // 추가 정보
  website               String?
  introduction          String?

  // 정산 계좌 정보 (공급자용)
  bankName              String?   @map("bank_name")
  bankAccount           String?   @map("bank_account")
  bankHolder            String?   @map("bank_holder")

  // 이미지
  profileImage          String?   @map("profile_image")
  businessLicenseImage  String?   @map("business_license_image")
  storeImages           String[]  @map("store_images")

  // 승인 상태
  approvalStatus        ApprovalStatus @default(pending) @map("approval_status")
  approvedAt            DateTime?      @map("approved_at")
  approvedById          String?        @map("approved_by")
  approvedBy            User?          @relation("ApprovedUsers", fields: [approvedById], references: [id])
  approvedUsers         User[]         @relation("ApprovedUsers")
  rejectionReason       String?        @map("rejection_reason")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  rfqs                  RFQ[]              @relation("BuyerRFQs")
  quotes                Quote[]            @relation("SupplierQuotes")
  buyerChatRooms        ChatRoom[]         @relation("BuyerChatRooms")
  supplierChatRooms     ChatRoom[]         @relation("SupplierChatRooms")
  chatMessages          ChatMessage[]
  buyerOrders           Order[]            @relation("BuyerOrders")
  supplierOrders        Order[]            @relation("SupplierOrders")
  notifications         Notification[]
  credit                Credit?
  creditLogs            CreditLog[]
  creditCharges         CreditCharge[]
  supplierAccount       SupplierAccount?
  buyerInvoices         Invoice[]          @relation("BuyerInvoices")
  supplierInvoices      Invoice[]          @relation("SupplierInvoices")

  @@index([role])
  @@index([approvalStatus])
  @@index([createdAt])
  @@index([companyName])
  @@map("users")
}

enum UserRole {
  buyer
  supplier
  admin
}

enum ApprovalStatus {
  pending
  approved
  rejected
  suspended
}

// ============================================
// 발주 (RFQs)
// ============================================

model RFQ {
  id              String    @id @default(cuid())
  buyerId         String    @map("buyer_id")
  buyer           User      @relation("BuyerRFQs", fields: [buyerId], references: [id], onDelete: Cascade)

  // 특정 공급자 타겟팅 (재발주용)
  targetSupplierId String?   @map("target_supplier_id")
  isTargeted       Boolean   @default(false) @map("is_targeted")  // 특정 공급자에게만 보이는 발주인지

  title           String
  category        String
  description     String
  quantity        Int
  unit            String
  desiredPrice    Int?      @map("desired_price")
  budgetMin       Int?      @map("budget_min")
  budgetMax       Int?      @map("budget_max")
  items           Json?

  // 간소화된 폼 신규 필드
  orderSizeRange  String?   @map("order_size_range")   // 평균 거래규모: "50만미만" | "50~100만원" | "100~300만원" | "300만원이상"
  orderFrequency  String?   @map("order_frequency")    // 발주주기: "비정기" | "주1회이상" | "주2~3회" | "월1~2회"
  referenceImages String[]  @map("reference_images")   // 참고사진 (Base64 인코딩)

  deliveryDate    DateTime  @map("delivery_date")
  deliveryAddress String    @map("delivery_address")

  status          RFQStatus @default(open)
  viewCount       Int       @default(0) @map("view_count")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  quotes          Quote[]
  chatRooms       ChatRoom[]
  orders          Order[]

  @@index([buyerId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@index([targetSupplierId])
  @@map("rfqs")
}

enum RFQStatus {
  open
  in_progress
  closed
  cancelled
}

// ============================================
// 제안 (Quotes)
// ============================================

model Quote {
  id              String      @id @default(cuid())
  rfqId           String      @map("rfq_id")
  rfq             RFQ         @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId      String      @map("supplier_id")
  supplier        User        @relation("SupplierQuotes", fields: [supplierId], references: [id], onDelete: Cascade)

  unitPrice       Int         @map("unit_price")
  totalPrice      Int         @map("total_price")
  deliveryDate    DateTime    @map("delivery_date")
  note            String?

  status          QuoteStatus @default(pending)
  acceptedAt      DateTime?   @map("accepted_at")

  // 제안 옵션
  optionType      QuoteOptionType @default(basic) @map("option_type")
  commissionRate  Float?          @map("commission_rate")
  isPremium       Boolean         @default(false) @map("is_premium")

  // 첨부파일 (견적서, 거래명세서 등)
  attachments     String[]    @map("attachments")

  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  chatRooms       ChatRoom[]
  orders          Order[]

  @@unique([rfqId, supplierId])
  @@index([supplierId])
  @@index([status])
  @@index([createdAt])
  @@map("quotes")
}

enum QuoteStatus {
  pending
  accepted
  rejected
  expired
}

enum QuoteOptionType {
  basic
  premium
}

// ============================================
// 채팅방 (Chat Rooms)
// ============================================

model ChatRoom {
  id              String        @id @default(cuid())
  rfqId           String        @map("rfq_id")
  rfq             RFQ           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  quoteId         String        @unique @map("quote_id")
  quote           Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  buyerId         String        @map("buyer_id")
  buyer           User          @relation("BuyerChatRooms", fields: [buyerId], references: [id], onDelete: Cascade)
  supplierId      String        @map("supplier_id")
  supplier        User          @relation("SupplierChatRooms", fields: [supplierId], references: [id], onDelete: Cascade)

  status          ChatRoomStatus @default(active)
  dealConfirmedAt DateTime?      @map("deal_confirmed_at")
  expiresAt       DateTime       @map("expires_at")

  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  messages        ChatMessage[]
  orders          Order[]

  @@unique([rfqId, supplierId])
  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
  @@index([createdAt])
  @@map("chat_rooms")
}

enum ChatRoomStatus {
  active
  payment_requested
  payment_confirmed
  deal_confirmed
  delivery_completed
  expired
  closed
}

// ============================================
// 채팅 메시지 (Chat Messages)
// ============================================

model ChatMessage {
  id          String    @id @default(cuid())
  chatRoomId  String    @map("chat_room_id")
  chatRoom    ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  senderId    String    @map("sender_id")
  sender      User      @relation(fields: [senderId], references: [id], onDelete: Cascade)

  content     String
  image       String?   @db.Text               // Base64 이미지
  senderType  String?   @map("sender_type")   // 'buyer' | 'supplier' | 'system'
  senderName  String?   @map("sender_name")   // 표시용 발신자 이름
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")

  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([chatRoomId])
  @@index([senderId])
  @@index([createdAt])
  @@index([chatRoomId, createdAt])
  @@index([chatRoomId, isRead])
  @@map("chat_messages")
}

// ============================================
// 주문 (Orders)
// ============================================

model Order {
  id              String        @id @default(cuid())
  chatRoomId      String        @map("chat_room_id")
  chatRoom        ChatRoom      @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  rfqId           String        @map("rfq_id")
  rfq             RFQ           @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  quoteId         String        @map("quote_id")
  quote           Quote         @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  buyerId         String        @map("buyer_id")
  buyer           User          @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  supplierId      String        @map("supplier_id")
  supplier        User          @relation("SupplierOrders", fields: [supplierId], references: [id], onDelete: Cascade)

  productAmount   Int           @map("product_amount")
  totalAmount     Int           @map("total_amount")
  commissionAmount Int          @map("commission_amount")
  buyerFee        Int?          @map("buyer_fee")
  supplierFee     Int?          @map("supplier_fee")

  status          OrderStatus   @default(pending)
  paymentMethod   PaymentMethod @map("payment_method")
  paymentKey      String?       @map("payment_key")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  logs            OrderLog[]
  invoice         Invoice?

  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
  @@index([createdAt])
  @@index([chatRoomId])
  @@index([rfqId])
  @@index([quoteId])
  @@index([buyerId, status])
  @@index([supplierId, status])
  @@map("orders")
}

enum OrderStatus {
  pending
  payment_pending
  paid
  preparing
  shipping
  delivered
  confirmed
  completed
  cancelled
}

enum PaymentMethod {
  escrow
  direct
  card
  bank_transfer
}

// ============================================
// 주문 로그 (Order Logs)
// ============================================

model OrderLog {
  id        String   @id @default(cuid())
  orderId   String   @map("order_id")
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status    String
  note      String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([orderId, createdAt])
  @@map("order_logs")
}

// ============================================
// 알림 (Notifications)
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String
  link      String?

  isRead    Boolean          @default(false) @map("is_read")
  readAt    DateTime?        @map("read_at")

  createdAt DateTime         @default(now()) @map("created_at")

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

enum NotificationType {
  new_quote
  new_message
  deal_confirmed
  deal_completed
  order_update
  chat_expiring
  chat_expired
  payment_request
  payment_confirmed
  delivery_completed
  invoice_issued
  announcement
  system
}

// ============================================
// 문의 (Inquiries)
// ============================================

model Inquiry {
  id          String        @id @default(cuid())
  name        String
  email       String
  phone       String?
  subject     String
  message     String

  status      InquiryStatus @default(pending)
  response    String?
  respondedAt DateTime?     @map("responded_at")
  respondedBy String?       @map("responded_by")

  createdAt   DateTime      @default(now()) @map("created_at")

  @@index([status])
  @@index([createdAt])
  @@map("inquiries")
}

enum InquiryStatus {
  pending
  in_progress
  resolved
  closed
}

// ============================================
// 크레딧 (Credits)
// ============================================

model Credit {
  id          String   @id @default(cuid())
  supplierId  String   @unique @map("supplier_id")
  supplier    User     @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  balance     Int      @default(0)

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("credits")
}

// ============================================
// 크레딧 로그 (Credit Logs)
// ============================================

model CreditLog {
  id           String        @id @default(cuid())
  supplierId   String        @map("supplier_id")
  supplier     User          @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  amount       Int
  type         CreditLogType
  description  String?
  referenceId  String?       @map("reference_id")
  balanceAfter Int           @map("balance_after")

  createdAt    DateTime      @default(now()) @map("created_at")

  @@index([supplierId])
  @@index([type])
  @@index([createdAt])
  @@map("credit_logs")
}

enum CreditLogType {
  charge
  use
  refund
}

// ============================================
// 크레딧 충전 요청 (Credit Charges)
// ============================================

model CreditCharge {
  id            String             @id @default(cuid())
  supplierId    String             @map("supplier_id")
  supplier      User               @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  amount        Int
  status        CreditChargeStatus @default(pending)
  paymentMethod String?            @map("payment_method")
  createdAt     DateTime           @default(now()) @map("created_at")
  completedAt   DateTime?          @map("completed_at")

  @@index([supplierId])
  @@index([status])
  @@map("credit_charges")
}

enum CreditChargeStatus {
  pending
  completed
  cancelled
}

// ============================================
// 공급자 계좌 정보 (Supplier Accounts)
// ============================================

model SupplierAccount {
  id            String   @id @default(cuid())
  supplierId    String   @unique @map("supplier_id")
  supplier      User     @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  bankName      String   @map("bank_name")
  accountNumber String   @map("account_number")
  accountHolder String   @map("account_holder")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("supplier_accounts")
}

// ============================================
// CMS 페이지 (Pages)
// ============================================

model Page {
  id          String     @id @default(cuid())
  slug        String     @unique
  title       String
  description String?
  content     String     @db.Text
  status      PageStatus @default(draft)

  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  @@map("pages")
}

enum PageStatus {
  published
  draft
}

// ============================================
// 사이트 설정 (Site Settings)
// ============================================

model SiteSettings {
  id                String   @id @default("default")

  // 기본 정보
  siteName          String   @default("OnTheDeal") @map("site_name")
  siteDescription   String?  @map("site_description")
  contactEmail      String?  @map("contact_email")
  contactPhone      String?  @map("contact_phone")
  address           String?

  // 사업자 정보
  ceoName           String?  @map("ceo_name")
  businessNumber    String?  @map("business_number")
  businessAddress   String?  @map("business_address")

  // 입금 계좌 정보
  bankName          String?  @map("bank_name")
  bankAccount       String?  @map("bank_account")
  bankHolder        String?  @map("bank_holder")

  // 알림 설정
  emailNotifications Boolean @default(true) @map("email_notifications")
  smsNotifications   Boolean @default(true) @map("sms_notifications")
  adminAlertEmail    String? @map("admin_alert_email")

  // 운영 시간
  businessHoursStart String? @map("business_hours_start")
  businessHoursEnd   String? @map("business_hours_end")
  businessDays       String? @map("business_days")

  // 수수료 설정
  firstTradeCommissionRate  Float    @default(3.0)    // 첫 거래 수수료율 (%)
  repeatTradeCommissionRate Float    @default(1.0)    // 연속 거래 수수료율 (%)
  buyerCardPaymentRate      Float    @default(3.0)    // 구매자 카드결제 수수료율 (%)
  buyerBankTransferRate     Float    @default(0.0)    // 구매자 계좌이체 수수료율 (%)
  chatExpiryDays            Int      @default(3)      // 채팅방 만료일
  maxProposalsPerHour       Int      @default(0)      // 시간당 최대 제안수 (0=무제한)

  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

// ============================================
// 거래명세표 (Invoices)
// ============================================

model Invoice {
  id              String    @id @default(cuid())
  invoiceNumber   String    @unique              // 명세표 번호 (INV-YYYYMMDD-XXXX)
  orderId         String    @unique
  order           Order     @relation(fields: [orderId], references: [id])
  buyerId         String
  buyer           User      @relation("BuyerInvoices", fields: [buyerId], references: [id])
  supplierId      String
  supplier        User      @relation("SupplierInvoices", fields: [supplierId], references: [id])
  items           Json                            // 품목 상세
  productAmount   Int                             // 상품 금액
  commissionRate  Float                           // 적용된 수수료율 (%)
  commissionAmount Int                            // 수수료 금액
  totalAmount     Int                             // 총 금액
  isRepeatTrade   Boolean   @default(false)       // 연속거래 여부
  status          String    @default("issued")    // issued, confirmed, cancelled
  issuedAt        DateTime  @default(now())
  confirmedAt     DateTime?
  cancelledAt     DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([buyerId])
  @@index([supplierId])
  @@index([status])
  @@index([issuedAt])
  @@index([buyerId, status])
  @@index([supplierId, status])
}

// ============================================
// 공지사항 (Announcements)
// ============================================

model Announcement {
  id          String             @id @default(cuid())
  title       String
  content     String             @db.Text
  category    AnnouncementCategory @default(general)
  isPinned    Boolean            @default(false) @map("is_pinned")
  isPublished Boolean            @default(false) @map("is_published")
  authorId    String             @map("author_id")
  viewCount   Int                @default(0) @map("view_count")

  publishedAt DateTime?          @map("published_at")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")

  @@index([isPublished])
  @@index([isPinned])
  @@index([category])
  @@index([createdAt])
  @@index([isPublished, createdAt])
  @@index([isPublished, isPinned])
  @@map("announcements")
}

enum AnnouncementCategory {
  general     // 일반
  update      // 업데이트
  maintenance // 점검
  event       // 이벤트
  policy      // 정책
}
