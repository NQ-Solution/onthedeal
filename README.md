# OnTheDeal - B2B 식자재 거래 플랫폼

> **도메인**: onthedeal.com
> **개발사**: NQ Solution (nqsolution.kr)

## 프로젝트 개요
식자재 구매자와 공급자를 직접 연결하는 B2B 거래 플랫폼입니다.

---

## 사용자별 플로우 요약

### 구매자 (Buyer) - 무료
```
[회원가입] → [관리자 승인] → [로그인] → [발주 등록] → [제안 검토] → [채팅/협상] → [거래 확정]
```

### 공급자 (Supplier) - 크레딧 필요
```
[회원가입] → [관리자 승인] → [로그인] → [크레딧 충전] → [발주 확인] → [제안 제출] → [채팅/협상] → [거래 확정]
```

### 관리자 (Admin)
```
[로그인] → [회원 승인/관리] → [크레딧 수동 충전] → [거래 모니터링]
```

---

## 상세 플로우

### 1. 회원가입 및 승인 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                        회원가입 플로우                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [사용자]                                                       │
│     │                                                           │
│     ▼                                                           │
│  ┌──────────────┐                                               │
│  │  회원가입     │  • 구매자 or 공급자 선택                        │
│  │  폼 작성     │  • 사업자 정보 입력                             │
│  └──────┬───────┘  • 대표자명 (필수)                             │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐                                               │
│  │ 승인 대기     │  approvalStatus: 'pending'                   │
│  │ 상태 생성    │  (공급자는 Credit 계정도 자동 생성, 잔액 0원)     │
│  └──────┬───────┘                                               │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐                                               │
│  │ 관리자 알림  │  새 회원 승인 요청                              │
│  │ /admin/users │                                               │
│  └──────┬───────┘                                               │
│         │                                                       │
│  ┌──────┴──────┬───────────────┐                                │
│  │             │               │                                │
│  ▼             ▼               ▼                                │
│ [승인]       [거절]          [정지]                              │
│ approved    rejected        suspended                          │
│  │             │               │                                │
│  ▼             ▼               ▼                                │
│ 로그인       로그인          로그인                              │
│ 가능         불가            불가                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**관련 코드:**
- 회원가입 API: `app/api/auth/register/route.ts`
- 로그인 인증: `lib/auth.ts`
- 관리자 회원관리: `app/(admin)/admin/users/`

---

### 2. 크레딧 충전 플로우 (공급자 전용)

```
┌─────────────────────────────────────────────────────────────────┐
│                   현재 - 계좌이체 방식                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [공급자] /supplier/credits                                     │
│     │                                                           │
│     ▼                                                           │
│  ┌──────────────┐                                               │
│  │ 충전 금액    │  10만원 / 30만원 / 50만원 / 100만원             │
│  │ 선택        │  또는 직접 입력 (최소 10만원)                    │
│  └──────┬───────┘                                               │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────────────────────────┐                           │
│  │ 입금 정보 확인                    │                           │
│  │ • 입금 계좌: 신한은행 xxx         │  ← 관리자 설정에서 변경 가능 │
│  │ • 예금주: (주)온더딜              │  /admin/settings          │
│  │ • 입금자명: 회사명                │                           │
│  │ • 입금 금액: 선택한 금액          │                           │
│  └──────┬───────────────────────────┘                           │
│         │                                                       │
│         ▼                                                       │
│  [공급자가 실제 은행 이체 진행]                                   │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐                                               │
│  │ 관리자       │  /admin/credits                               │
│  │ 입금 확인   │  • 공급자 검색                                  │
│  │ 후 수동충전  │  • 충전 금액 입력                              │
│  └──────┬───────┘  • 충전 사유 입력 (예: 계좌이체 확인)           │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐                                               │
│  │ 크레딧 충전  │  • Credit.balance 증가                         │
│  │ 완료        │  • CreditLog 기록 생성 (type: 'charge')        │
│  └──────────────┘                                               │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                   미래 - PG 연동 방식 (준비 중)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  결제 요청 → PG사(토스페이먼츠) → Webhook → 자동 충전             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**관련 코드:**
- 공급자 크레딧 페이지: `app/(dashboard)/supplier/credits/page.tsx`
- 관리자 크레딧 관리: `app/(admin)/admin/credits/page.tsx`
- 크레딧 API: `app/api/admin/credits/route.ts`
- 계좌 설정: `app/(admin)/admin/settings/page.tsx`

---

### 3. 발주-제안-거래 플로우

```
┌─────────────────────────────────────────────────────────────────┐
│                     발주-제안-거래 플로우                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [구매자]                           [공급자]                     │
│     │                                  │                        │
│     ▼                                  │                        │
│  ┌──────────────┐                      │                        │
│  │ 발주 등록    │  RFQ 생성            │                        │
│  │ (무료)      │  status: 'open'      │                        │
│  └──────┬───────┘                      │                        │
│         │                              │                        │
│         │  발주 목록 노출 ─────────────▶│                        │
│         │                              ▼                        │
│         │                     ┌──────────────┐                  │
│         │                     │ 발주 확인    │                  │
│         │                     │ /supplier/rfqs│                  │
│         │                     └──────┬───────┘                  │
│         │                            │                          │
│         │                            ▼                          │
│         │                     ┌──────────────┐                  │
│         │                     │ 크레딧 확인  │                  │
│         │                     │ 잔액 >= 3%  │  ← 구매희망가 기준  │
│         │                     └──────┬───────┘                  │
│         │                            │                          │
│         │                     ┌──────┴──────┐                   │
│         │                     │             │                   │
│         │               충분함 ▼       부족함 ▼                   │
│         │           ┌──────────┐   ┌──────────┐                 │
│         │           │ 제안 제출 │   │ 충전 안내 │                 │
│         │           │ 가능     │   │ 표시     │                 │
│         │           └────┬─────┘   └────┬─────┘                 │
│         │                │              │                       │
│         │                │         충전 후 재시도               │
│         │                ▼                                      │
│         │         ┌──────────────┐                              │
│         │         │ 제안 제출    │                              │
│         │         │ (POST /api/  │  • Quote 생성                │
│         │         │  quotes)     │  • 크레딧 3% 선차감          │
│         │         │              │  • CreditLog 기록            │
│         │         │              │  • ChatRoom 자동 생성        │
│         │         └──────┬───────┘                              │
│         │                │                                      │
│         │◀───────────────┘                                      │
│         ▼                                                       │
│  ┌──────────────┐                                               │
│  │ 제안 검토    │                                               │
│  │ /buyer/     │                                               │
│  │ quotes      │                                               │
│  └──────┬───────┘                                               │
│         │                                                       │
│         ▼                                                       │
│  ┌──────────────┐          ┌──────────────┐                     │
│  │ 채팅 시작    │◀────────▶│ 채팅 참여    │                     │
│  │ /chat/[id]  │          │              │                     │
│  └──────┬───────┘          └──────────────┘                     │
│         │                                                       │
│         │  ⏰ 3일 이내 거래 확정 필요                             │
│         │                                                       │
│  ┌──────┴──────┐                                                │
│  │             │                                                │
│  ▼             ▼                                                │
│ [거래 확정]  [미확정/만료]                                        │
│  │             │                                                │
│  ▼             ▼                                                │
│ 크레딧        크레딧                                              │
│ 수수료로      전액 환불                                          │
│ 전환         (type: 'refund')                                   │
│  │                                                              │
│  ▼                                                              │
│ 주문 생성                                                        │
│ Order                                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**관련 코드:**
- 발주 등록: `app/api/rfqs/route.ts`
- 발주 상세: `app/api/rfqs/[id]/route.ts`
- 제안 API: `app/api/quotes/route.ts` (크레딧 체크/차감 로직 포함)
- 공급자 발주 상세: `app/(dashboard)/supplier/rfqs/[id]/page.tsx`

---

## 크레딧 시스템 상세

### 수수료 정책

| 구분 | 비율 | 시점 | 설명 |
|------|------|------|------|
| **제안 선차감** | 3% | 제안 제출 시 | 구매 희망가 최소금액 기준 |
| **거래 확정** | - | 확정 시 | 선차감 금액이 수수료로 전환 |
| **환불** | 100% | 3일 후 미확정 시 | 선차감 금액 전액 환불 |

### 크레딧 로그 타입 (CreditLog)

| 타입 | amount | 설명 |
|------|--------|------|
| `charge` | +금액 | 크레딧 충전 (관리자 또는 PG) |
| `use` | -금액 | 크레딧 사용 (제안 제출) |
| `refund` | +금액 | 크레딧 환불 (거래 미확정) |

### 크레딧 체크 조건 (제안 제출 시)
```typescript
// app/api/quotes/route.ts
const baseAmount = rfq.budgetMin || totalPrice
const creditDeduction = Math.round(baseAmount * 0.03)

if (!credit || credit.balance < creditDeduction) {
  return NextResponse.json({
    error: '크레딧이 부족합니다',
    required: creditDeduction,
    current: credit?.balance || 0,
  }, { status: 400 })
}
```

---

## 주요 API 엔드포인트

### 인증
| Method | Path | 설명 |
|--------|------|------|
| POST | `/api/auth/register` | 회원가입 |
| POST | `/api/auth/[...nextauth]` | 로그인/로그아웃 |

### 회원 관리 (Admin)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/admin/users` | 회원 목록 |
| POST | `/api/admin/users` | 회원 승인/거절/정지 |
| GET | `/api/admin/users/[id]` | 회원 상세 |

### 크레딧
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/supplier/credits` | 내 크레딧 조회 |
| GET | `/api/admin/credits` | 공급자 목록 및 충전 내역 |
| POST | `/api/admin/credits` | 크레딧 수동 충전 |

### 발주 (RFQ)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/rfqs` | 발주 목록 |
| POST | `/api/rfqs` | 발주 등록 |
| GET | `/api/rfqs/[id]` | 발주 상세 |

### 제안 (Quote)
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/quotes` | 제안 목록 |
| POST | `/api/quotes` | 제안 제출 (크레딧 차감 포함) |

### 설정
| Method | Path | 설명 |
|--------|------|------|
| GET | `/api/settings` | 사이트 설정 조회 (공개) |
| GET | `/api/admin/settings` | 설정 조회 (관리자) |
| PUT | `/api/admin/settings` | 설정 저장 (관리자) |

---

## 관리자 설정 항목

### 사이트 기본 정보
- 사이트 이름, 설명
- 대표 이메일, 전화번호, 주소

### 사업자 정보 (푸터에 자동 표시)
- 대표자명
- 사업자등록번호
- 사업자 주소

### 입금 계좌 정보 (공급자 크레딧 충전 시 표시)
- 은행명
- 계좌번호
- 예금주

### 수수료 설정
- 카드 결제 수수료율 (준비 중)
- 계좌이체 수수료율
- 공급자 수수료율 (기본/프리미엄)

---

## 기술 스택
- **Frontend**: Next.js 14 (App Router), React 18, TypeScript
- **Styling**: Tailwind CSS
- **Backend**: Next.js API Routes
- **Database**: PostgreSQL + Prisma ORM (Prisma Accelerate)
- **Auth**: NextAuth.js (JWT 기반)
- **Payment**: 토스페이먼츠 (준비 중)

---

## 개발 환경 설정

### 1. 의존성 설치
```bash
npm install
```

### 2. 환경변수 설정
```bash
cp .env.example .env.local
```

`.env.local` 파일에 필요한 정보 입력:
```env
# Database (Prisma Accelerate)
DATABASE_URL=prisma+postgres://accelerate.prisma-data.net/?api_key=YOUR_API_KEY

# NextAuth
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secure-random-key-min-32-chars

# App URL
NEXT_PUBLIC_APP_URL=http://localhost:3000

# 토스페이먼츠 (선택)
NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_xxx
TOSS_SECRET_KEY=test_sk_xxx
```

### 3. 데이터베이스 설정
```bash
# 스키마 적용 (개발)
npx prisma db push

# 또는 마이그레이션 (프로덕션)
npx prisma migrate deploy
```

### 4. 개발 서버 실행
```bash
npm run dev
```

---

## 폴더 구조
```
onthedeal/
├── app/
│   ├── (admin)/              # 관리자 페이지
│   │   └── admin/
│   │       ├── users/        # 회원 관리
│   │       ├── credits/      # 크레딧 관리
│   │       ├── settings/     # 사이트 설정
│   │       └── ...
│   ├── (auth)/               # 인증 페이지
│   │   ├── login/
│   │   └── register/
│   ├── (dashboard)/          # 대시보드
│   │   ├── buyer/            # 구매자 페이지
│   │   │   ├── rfqs/         # 발주 관리
│   │   │   └── quotes/       # 받은 제안
│   │   └── supplier/         # 공급자 페이지
│   │       ├── credits/      # 크레딧 충전
│   │       ├── rfqs/         # 발주 목록/상세 (제안 제출)
│   │       └── quotes/       # 제안 관리
│   ├── chat/                 # 채팅 페이지
│   └── api/                  # API 라우트
│       ├── auth/             # 인증 API
│       ├── admin/            # 관리자 API
│       ├── rfqs/             # 발주 API
│       ├── quotes/           # 제안 API
│       ├── supplier/         # 공급자 API
│       └── settings/         # 설정 API (공개)
├── components/               # 공통 컴포넌트
│   ├── ui/                   # UI 컴포넌트
│   └── layout/               # 레이아웃
├── lib/                      # 유틸리티
│   ├── db.ts                 # Prisma 클라이언트
│   ├── auth.ts               # NextAuth 설정
│   └── ...
├── prisma/                   # 데이터베이스 스키마
│   └── schema.prisma
├── types/                    # TypeScript 타입
└── public/                   # 정적 파일
```

---

## 계정 유형

### 운영 계정
- **관리자**: 실제 인증 필요 (회원가입 불가, DB에서 직접 생성)
- **구매자/공급자**: 회원가입 후 관리자 승인 필요

### 데모 계정 (영업/시연용)
```
구매자: demo-buyer@onthedeal.com / demo1234!
공급자: demo-supplier@onthedeal.com / demo1234!
```
> 데모 계정은 DB에 미리 생성되어 있어야 합니다.

---

## 보안 체크리스트

- [x] 비밀번호 해싱 (bcrypt, 12 rounds)
- [x] JWT 세션 (30일 만료)
- [x] 역할 기반 접근 제어 (RBAC)
- [x] API 인증 체크
- [x] 결제 금액 검증
- [x] 회원가입 시 admin 역할 등록 방지
- [x] 환경변수 파일 gitignore
- [ ] Rate limiting (추후 적용 권장)
- [ ] 웹훅 서명 검증 (토스페이먼츠)

---

## 향후 개발 계획

1. **PG 결제 연동** - 토스페이먼츠 카드 결제
2. **알림 시스템** - 이메일/SMS 알림
3. **채팅 만료 자동화** - 3일 후 자동 환불 처리 (Cron Job)
4. **결제 시스템** - 에스크로 결제 지원
5. **리뷰 시스템** - 거래 완료 후 평가

---

## 문의
- **이메일**: support@onthedeal.com
- **전화**: 02-1234-5678
- **개발사**: NQ Solution (https://nqsolution.kr)

---

## 라이선스
© 2026 NQ Solution. All rights reserved.
